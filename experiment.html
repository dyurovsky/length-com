<!DOCTYPE html>
<html>
  <head>
    <title>Alien language game</title>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="mmturkey-0.6.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-external-html.js"></script>
    <script src="consent/consent.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="jspsych-6.1.0/css/jspsych.css"></link>
  </head>
  <body></body>
  <script>

    /* create timeline */
    var timeline = [];

    // utts
    var complex_utt = "<i>\"Toma zem zorp bidaku midu osh gipu!\"</i>"
    var simple_utt = "<i>\"Toma!\"</i>"


    //const random_utt = utts[Math.floor(Math.random() * utts.length)];

    // boxes
    var num_boxes = ['num_objects/box_1', 'num_objects/box_2']
    var type_boxes =  ['num_types/box_1', 'num_types/box_2']
    var entropy_boxes =  ['entropy/box_1', 'entropy/box_2']

    var all_boxes = [num_boxes, type_boxes, entropy_boxes];

    var factors = {
      utt: [simple_utt, complex_utt],
      boxes: all_boxes,
      side: [1,2]
    }

    var full_design = jsPsych.randomization.factorial(factors, 1);

    var i;

    for(i = 0; i < full_design.length; i++) {

      full_design[i].data = {test_part: 'test'}

      if(full_design[i].utt == complex_utt) {
        full_design[i].data['utt_type'] = 'complex'
        if(full_design[i].side == 1) {
          full_design[i].boxes.reverse();
          full_design[i].data['correct_side'] = 0;
        } else {
          full_design[i].data['correct_side'] = 1;
        }
      } else {
        full_design[i].data['utt_type'] = 'simple'
        if(full_design[i].side == 2) {
          full_design[i].boxes.reverse();
          full_design[i].data['correct_side'] = 1;
        } else {
          full_design[i].data['correct_side'] = 0;
        }
      }
      switch(full_design[i].boxes) {
        case num_boxes:
          full_design[i].data['boxes_type'] = 'num'
          break;
        case type_boxes:
          full_design[i].data['boxes_type'] = 'type'
          break;
        case entropy_boxes:
          full_design[i].data['boxes_type'] = 'entropy'
      }
    }

    var consent = {
      type:'external-html',
      url: "consent/consent.html",
      cont_btn: "start"
    };

    console.log(full_design)

    timeline.push(consent);

    /* define instructions trial */
    var instructions = {
      type: "html-button-response",
      stimulus: "<p>In this experiment, you will see some aliens talk " +
          "and make judgments about what they are talking about.",
      choices: ['Start'],
      data: {test_part: 'setup'},
      post_trial_gap: 2000
    };
    timeline.push(instructions);

    var hi_alien = {
      type: 'html-button-response',
      stimulus: "<p>This is Dax the alien. He speaks an alien language." +
          '<br><br>He says, <i> "Difu Dax midaku."</i><br>' +
          'That means "Hello, my name is Dax."</p><br>' +

          "<div style='width: 700px;'>"+
          "<div style='float: center;'><img src='img/alien1.png' width='250' height='300'></img></div>" +
          "</div><br>",
      choices: ['Continue'],
      data: {test_part: 'setup'}
    }

    var show_box = {
      type: 'html-button-response',
      stimulus: function() { return "<p>Dax has a box. <br>" +
        " He opened the box and looked inside <br><br>" +
        "Then, Dax says, " + jsPsych.timelineVariable('utt', true) + "</p>" +
        "<div style='width: 700px;'>" +
        "<div style='float: center;'><img src='img/alien1.png' width='250' height='300'></img></div>" +
        "<div style='float: center;'><img src='img/grey_box.png'></img></div>"+
        "</div><br>";
      },
      choices: ['Continue'],
      data: {test_part: 'setup'}
    }

    var test_box = {
      type: 'html-button-response',
      stimulus: function(){ return "<p>Which box do you think Dax was " +
        "looking in when he said<br>" + jsPsych.timelineVariable('utt', true) + "?</p>" +
        "<div style='width: 700px;'>"+
        "</div>";
      },
      data: jsPsych.timelineVariable('data'),
      choices: jsPsych.timelineVariable('boxes'),
      button_html: '<button style="border:none;"> <img width="250px" src = "img/%choice%.png"> </img> </button>'
    }

    var test_procedure = {
      timeline_variables: full_design,
      timeline: [hi_alien, show_box, test_box],
      sample: {
        type: 'without-replacement',
        size: 1
      }
    }
    timeline.push(test_procedure);

    /* start the experiment */
    jsPsych.init({
      timeline: timeline,
      on_finish: function() {
        dataToSend = jsPsych.data.get().filter({trial_type: 'html-slider-response'}).csv()
        turk.submit(dataToSend)
        //jsPsych.data.displayData();
      }
    });
  </script>
</html>
